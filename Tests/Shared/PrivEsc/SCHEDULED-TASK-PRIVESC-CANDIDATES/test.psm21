# ================================================================
# Function: fncGetScheduledTaskPrivEscCandidates
# Purpose : Identify high privilege scheduled tasks with writable action targets
# ================================================================
function fncGetScheduledTaskPrivEscCandidates {

    fncPrintMessage "Scanning scheduled tasks for high privilege principals and writable action targets..." "info"
    fncPrintMessage "Initialising scheduled task privilege escalation scan (v5)." "debug"
    Write-Host ""

    $currentIdentity = [System.Security.Principal.WindowsIdentity]::GetCurrent()
    $currentUser     = $currentIdentity.Name

    fncPrintMessage ("Current identity: {0}" -f $currentUser) "debug"

    # ----------------------------------------------------------
    # Helper: Extract Executable From Command Line
    # ----------------------------------------------------------
    function fncGetExecutableFromCommandLine {
        param([string]$CommandLine)

        if (-not $CommandLine) { return $null }

        $cmd = $CommandLine.Trim()

        if ($cmd -match '^\s*"(.*?)"') {
            return $matches[1]
        }

        return $cmd.Split(" ")[0]
    }

    $hits = @()

    # ----------------------------------------------------------
    # Validate Cmdlet
    # ----------------------------------------------------------
    if (-not (Get-Command Get-ScheduledTask -ErrorAction SilentlyContinue)) {

        fncAddFinding `
            -Id ("SCHEDTASK_CMDLET_MISSING_" + (fncShortHashTag "CMDLET_MISSING")) `
            -Category "Privilege Escalation" `
            -Title "Scheduled Task Cmdlet Not Available" `
            -Severity "Low" `
            -Status "Unknown" `
            -Message "Get-ScheduledTask cmdlet is not available." `
            -Recommendation "Upgrade PowerShell or query tasks via alternate enumeration."

        return
    }

    # ----------------------------------------------------------
    # Enumerate Tasks
    # ----------------------------------------------------------
    try {
        $tasks = Get-ScheduledTask -ErrorAction Stop
        fncPrintMessage ("Enumerated scheduled tasks: {0}" -f (($tasks | Measure-Object).Count)) "debug"
    }
    catch {

        fncAddFinding `
            -Id ("SCHEDTASK_ENUM_FAILED_" + (fncShortHashTag "ENUM_FAIL")) `
            -Category "Privilege Escalation" `
            -Title "Scheduled Task Enumeration Failed" `
            -Severity "Low" `
            -Status "Unknown" `
            -Message "Unable to enumerate scheduled tasks." `
            -Recommendation "Verify permissions." `
            -Evidence $_.Exception.Message

        return
    }

    foreach ($task in $tasks) {

        try {

            if ($task.State -eq "Disabled") { continue }

            $principal = $task.Principal
            $userId    = fncSafeString $principal.UserId
            $runLevel  = fncSafeString $principal.RunLevel

            # ------------------------------------------------------
            # High Privilege Classification
            # ------------------------------------------------------
            $isHighPrivPrincipal = $false

            if ($userId -match "SYSTEM" -or
                $userId -match "LocalService" -or
                $userId -match "NetworkService") {
                $isHighPrivPrincipal = $true
            }
            elseif ($runLevel -eq "Highest") {
                $isHighPrivPrincipal = $true
            }

            if (-not $isHighPrivPrincipal) { continue }

            foreach ($action in $task.Actions) {

                if (-not $action.Execute) { continue }

                $cmdline = $action.Execute + " " + (fncSafeString $action.Arguments)
                $exePathRaw = fncGetExecutableFromCommandLine -CommandLine $cmdline
                if (-not $exePathRaw) { continue }

                $expanded = [Environment]::ExpandEnvironmentVariables($exePathRaw)
                if (-not (Test-Path $expanded -ErrorAction SilentlyContinue)) { continue }

                $fullPath = (Get-Item -LiteralPath $expanded -ErrorAction SilentlyContinue).FullName
                if (-not $fullPath) { continue }

                $acl   = Get-Acl -LiteralPath $fullPath -ErrorAction SilentlyContinue
                if (-not $acl) { continue }

                $owner = fncSafeString $acl.Owner

                $fileWritable = Test-CurrentUserCanModifyPath -Path $fullPath
                $dirPath      = [System.IO.Path]::GetDirectoryName($fullPath)
                $dirWritable  = $false

                if ($dirPath) {
                    $dirWritable = Test-CurrentUserCanModifyPath -Path $dirPath
                }

                # ------------------------------------------------------
                # MareBackup Detection
                # ------------------------------------------------------
                $isMareBackup = $false
                if ($task.TaskName -match "marebackup" -or
                    $cmdline -match "marebackup") {
                    $isMareBackup = $true
                }

                if (-not $fileWritable -and -not $dirWritable -and -not $isMareBackup) {
                    continue
                }

                $writableWhere = @()
                if ($fileWritable) { $writableWhere += "file" }
                if ($dirWritable)  { $writableWhere += "directory" }
                if ($isMareBackup) { $writableWhere += "marebackup-pattern" }

                $msg = "Task '$($task.TaskPath)$($task.TaskName)' runs as '$userId' (RunLevel=$runLevel) " +
                       "with action '$cmdline' (Owner=$owner). Writable by $currentUser via $($writableWhere -join ', ')."

                Write-Host ("[!] High-priv scheduled task candidate: {0}" -f $msg) -ForegroundColor Red

                $fingerprint = $task.TaskPath + $task.TaskName + $fullPath
                $tag = fncShortHashTag $fingerprint

                fncAddFinding `
                    -Id ("SCHEDTASK_PRIVESC_$tag") `
                    -Category "Privilege Escalation" `
                    -Title "Writable High Privilege Scheduled Task" `
                    -Severity "High" `
                    -Status "Detected" `
                    -Message "Scheduled task runs with elevated privileges and references a writable executable or directory." `
                    -Recommendation "Restrict file or directory permissions and review task configuration." `
                    -Evidence $msg

                $hits += $task
            }
        }
        catch {
            fncPrintMessage ("Exception processing task: {0}" -f $_.Exception.Message) "debug"
            continue
        }
    }

    # ----------------------------------------------------------
    # Summary
    # ----------------------------------------------------------
    if ($hits.Count -eq 0) {

        fncAddFinding `
            -Id ("SCHEDTASK_NO_PRIVESC_" + (fncShortHashTag "NONE_FOUND")) `
            -Category "Privilege Escalation" `
            -Title "No Writable High Privilege Scheduled Tasks Found" `
            -Severity "Good" `
            -Status "Not Detected" `
            -Message "No scheduled tasks with writable elevated execution paths were identified." `
            -Recommendation "No action required."

        return
    }

    fncPrintMessage ("Found {0} writable high privilege scheduled tasks." -f $hits.Count) "warning"
    fncPrintMessage "Scheduled task privilege escalation scan completed." "debug"
}

Export-ModuleMember -Function fncGetScheduledTaskPrivEscCandidates